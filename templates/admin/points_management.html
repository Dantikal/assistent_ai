{% extends "admin/base_site.html" %}

{% block title %}Управление очками - Админ панель{% endblock %}

{% block extrahead %}
<style>
.points-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.3s ease;
}

.points-card:hover {
    transform: translateY(-5px);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin: 10px 0;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-radius: 10px;
    background: white;
    margin-bottom: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.user-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.user-points {
    font-size: 1.2rem;
    font-weight: bold;
    color: #667eea;
}

.adjustment-item {
    border-left: 4px solid #667eea;
    padding: 15px;
    margin-bottom: 10px;
    background: #f8f9fa;
    border-radius: 8px;
}

.points-positive {
    color: #28a745;
    font-weight: bold;
}

.points-negative {
    color: #dc3545;
    font-weight: bold;
}

.form-section {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.btn-adjust {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.btn-adjust:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    color: white;
}

.loading {
    display: none;
    text-align: center;
    padding: 20px;
}

.alert-custom {
    border-radius: 10px;
    border: none;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">
        <i class="fas fa-coins me-2"></i>Управление очками пользователей
    </h1>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="points-card text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <div class="stat-value">{{ total_users }}</div>
                <div>Всего пользователей</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="points-card text-center">
                <i class="fas fa-star fa-2x mb-2"></i>
                <div class="stat-value">{{ total_points }}</div>
                <div>Всего очков в системе</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="points-card text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <div class="stat-value">{{ avg_points|floatformat:0 }}</div>
                <div>Среднее очков</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Форма изменения очков -->
        <div class="col-md-6">
            <div class="form-section">
                <h3 class="mb-4">
                    <i class="fas fa-edit me-2"></i>Изменить очки пользователя
                </h3>
                <form id="adjustPointsForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="{{ form.user.id_for_label }}" class="form-label">Пользователь</label>
                        {{ form.user }}
                        <div id="currentPoints" class="form-text text-muted"></div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.points_change.id_for_label }}" class="form-label">Изменение очков</label>
                        {{ form.points_change }}
                        <div class="form-text">
                            <small class="text-muted">Положительное число - добавить, отрицательное - вычесть</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.reason.id_for_label }}" class="form-label">Причина</label>
                        {{ form.reason }}
                    </div>
                    <button type="submit" class="btn btn-adjust w-100">
                        <i class="fas fa-save me-2"></i>Изменить очки
                    </button>
                </form>
                <div id="adjustResult" class="mt-3"></div>
            </div>
        </div>

        <!-- Топ пользователи -->
        <div class="col-md-6">
            <div class="form-section">
                <h3 class="mb-4">
                    <i class="fas fa-trophy me-2"></i>Топ пользователи
                </h3>
                <div id="topUsers">
                    {% for user_profile in top_users %}
                        <div class="user-item">
                            <div>
                                <strong>{{ user_profile.user.username }}</strong>
                                <br>
                                <small class="text-muted">{{ user_profile.user.get_full_name|default:user_profile.user.email }}</small>
                            </div>
                            <div class="user-points">{{ user_profile.points }} очков</div>
                        </div>
                    {% empty %}
                        <p class="text-muted">Пользователей пока нет</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Последние изменения -->
    <div class="form-section">
        <h3 class="mb-4">
            <i class="fas fa-history me-2"></i>Последние изменения очков
        </h3>
        <div id="recentAdjustments">
            {% for adjustment in recent_adjustments %}
                <div class="adjustment-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>{{ adjustment.user.username }}</strong>
                            <span class="{% if adjustment.points_change > 0 %}points-positive{% else %}points-negative{% endif %}">
                                {{ adjustment.points_change|default_if_none:"0"|add:"0"|stringformat:"+d" }}
                            </span>
                            <br>
                            <small class="text-muted">{{ adjustment.reason }}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">
                                {{ adjustment.created_at|date:"d.m.Y H:i" }}
                                {% if adjustment.created_by %}
                                    <br>Изменил: {{ adjustment.created_by.username }}
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="text-muted">Изменений пока нет</p>
            {% endfor %}
        </div>
        
        <div class="text-center mt-3">
            <a href="{% url 'admin_panel:points_history' %}" class="btn btn-outline-primary">
                <i class="fas fa-list me-2"></i>Вся история
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('{{ form.user.id_for_label }}');
    const currentPointsDiv = document.getElementById('currentPoints');
    const form = document.getElementById('adjustPointsForm');
    const resultDiv = document.getElementById('adjustResult');
    
    // Обновление текущих очков при выборе пользователя
    userSelect.addEventListener('change', function() {
        const userId = this.value;
        if (userId) {
            fetch(`/admin-panel/points/user/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentPointsDiv.textContent = `Текущие очки: ${data.points}`;
                        currentPointsDiv.className = 'form-text';
                        if (data.points < 100) {
                            currentPointsDiv.classList.add('text-warning');
                        } else if (data.points >= 500) {
                            currentPointsDiv.classList.add('text-success');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    currentPointsDiv.textContent = 'Ошибка загрузки данных';
                });
        } else {
            currentPointsDiv.textContent = '';
        }
    });
    
    // Обработка формы
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        // Показываем загрузку
        resultDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin me-2"></i>Сохранение...</div>';
        
        fetch('/admin-panel/points/adjust/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success alert-custom">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <br><small>Новый баланс: ${data.new_points} очков</small>
                    </div>
                `;
                
                // Обновляем текущие очки
                const userId = userSelect.value;
                if (userId) {
                    currentPointsDiv.textContent = `Текущие очки: ${data.new_points}`;
                }
                
                // Очищаем форму
                form.reset();
                
                // Обновляем список последних изменений через 2 секунды
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                let errorHtml = '<div class="alert alert-danger alert-custom"><i class="fas fa-exclamation-triangle me-2"></i>Ошибка:';
                if (data.errors) {
                    for (let field in data.errors) {
                        errorHtml += `<br>${field}: ${data.errors[field].join(', ')}`;
                    }
                } else {
                    errorHtml += data.error || 'Неизвестная ошибка';
                }
                errorHtml += '</div>';
                resultDiv.innerHTML = errorHtml;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultDiv.innerHTML = `
                <div class="alert alert-danger alert-custom">
                    <i class="fas fa-exclamation-triangle me-2"></i>Произошла ошибка при отправке запроса
                </div>
            `;
        });
    });
});
</script>
{% endblock %}
