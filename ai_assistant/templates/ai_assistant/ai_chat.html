{% extends 'base.html' %}

{% block title %}AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç - StudySense{% endblock %}

{% block extra_css %}
<style>
/* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ */
.hero-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 0;
    border-radius: 20px;
    margin-bottom: 2rem;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

.hero-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    background: linear-gradient(45deg, #fff, #f0f0f0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.hero-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 2rem;
}

.modern-card {
    border: none;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    overflow: hidden;
}

.modern-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.card-header-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 1.5rem;
    font-weight: 600;
}

.chat-container {
    height: 500px;
    overflow-y: auto;
    background: #f8f9fa;
    border-radius: 15px;
    padding: 1.5rem;
}

.message-bubble {
    border-radius: 20px;
    padding: 1rem 1.5rem;
    margin-bottom: 1rem;
    max-width: 80%;
    word-wrap: break-word;
    animation: fadeInUp 0.3s ease;
}

.user-message {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    margin-left: auto;
    text-align: right;
}

.ai-message {
    background: white;
    border: 2px solid #e9ecef;
    color: #333;
    margin-right: auto;
}

.input-group-modern {
    border-radius: 50px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.form-control-modern {
    border: none;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    border-radius: 50px;
}

.btn-send-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    padding: 1rem 2rem;
    border-radius: 50px;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-send-modern:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}

.example-btn {
    border: 2px solid #667eea;
    color: #667eea;
    border-radius: 15px;
    padding: 0.8rem 1.2rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: white;
}

.example-btn:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.typing-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: #e9ecef;
    border-radius: 15px;
    margin-bottom: 1rem;
}

.typing-dot {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    margin: 0 2px;
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

.status-badge {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.ai-response {
    line-height: 1.6;
    color: #333;
}

.ai-response strong {
    color: #667eea;
    font-weight: 600;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .hero-title { font-size: 2rem; }
    .hero-subtitle { font-size: 1rem; }
    .message-bubble { max-width: 95%; }
    .chat-container { height: 400px; }
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-robot me-2"></i>AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç
        </h1>
        <p class="text-muted">–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —É—á–µ–±–µ, –∏ —è –ø–æ–º–æ–≥—É –≤–∞–º —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è!</p>
    </div>
</div>

<div class="row mt-4">
    <!-- –ß–∞—Ç -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ß–∞—Ç —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º</h5>
            </div>
            <div class="card-body">
                <!-- –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–æ–≤ -->
                <div id="chat-history" class="mb-3" style="height: 400px; overflow-y: auto;">
                    {% for conversation in conversations %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-end mb-2">
                                <div class="bg-primary text-white p-3 rounded-3" style="max-width: 70%;">
                                    <strong>–í—ã:</strong><br>
                                    {{ conversation.student_question }}
                                    <br>
                                    <small>{{ conversation.created_at|date:"H:i" }}</small>
                                </div>
                            </div>
                            <div class="d-flex justify-content-start mb-2">
                                <div class="bg-light p-3 rounded-3" style="max-width: 70%;">
                                    <strong>AI:</strong><br>
                                    {{ conversation.ai_response }}
                                    <br>
                                    <small>{{ conversation.created_at|date:"H:i" }}</small>
                                </div>
                            </div>
                            
                            <!-- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ -->
                            {% if conversation.related_cards.all %}
                                <div class="ms-3 mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-book me-1"></i>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:
                                    </small>
                                    <div class="mt-1">
                                        {% for card in conversation.related_cards.all %}
                                            <a href="{% url 'card_detail' card.id %}" class="badge bg-info text-decoration-none me-1">
                                                {{ card.title }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <form id="chat-form">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="question-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..." required>
                        <button class="btn btn-primary" type="submit" id="send-btn">
                            <i class="fas fa-paper-plane"></i>
                            <span class="send-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-md-4">
        <!-- –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>–°–æ–≤–µ—Ç—ã –ø–æ –æ–±—â–µ–Ω–∏—é
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        –ó–∞–¥–∞–≤–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        –£–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ —Ç–µ–º—É
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        –ü—Ä–æ—Å–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        –ù–µ –±–æ–π—Ç–µ—Å—å –ø–µ—Ä–µ—Å–ø—Ä–∞—à–∏–≤–∞—Ç—å
                    </li>
                </ul>
            </div>
        </div>

        <!-- –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤ -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>–ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary text-start example-question">
                        –ß—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–∞—è –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ?
                    </button>
                    <button class="btn btn-outline-primary text-start example-question">
                        –û–±—ä—è—Å–Ω–∏ –∑–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
                    </button>
                    <button class="btn btn-outline-primary text-start example-question">
                        –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–æ—Ç–æ—Å–∏–Ω—Ç–µ–∑?
                    </button>
                    <button class="btn btn-outline-primary text-start example-question">
                        –î–∞–π –ø—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞–ª–æ–≤
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const questionInput = document.getElementById('question-input');
    const chatHistory = document.getElementById('chat-history');
    const sendBtn = document.getElementById('send-btn');
    const sendText = sendBtn.querySelector('.send-text');
    const spinner = sendBtn.querySelector('.spinner-border');

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ AI
    function formatAIResponse(response) {
        const sections = parseAiSections(response);
        if (!sections || sections.length === 0) {
            return escapeHtml(response).replace(/\n/g, '<br>');
        }

        const buttonsHtml = sections.map((s, idx) => {
            const activeClass = idx === 0 ? ' active' : '';
            return `<button type="button" class="btn btn-sm btn-outline-primary ai-section-btn${activeClass}" data-section-id="${s.id}">${escapeHtml(s.title)}</button>`;
        }).join('');

        const panelsHtml = sections.map((s, idx) => {
            const activeClass = idx === 0 ? ' active' : '';
            return `<div class="ai-section-panel${activeClass}" data-section-id="${s.id}">${escapeHtml(s.content).replace(/\n/g, '<br>')}</div>`;
        }).join('');

        return `
            <div class="ai-sectioned-response">
                <div class="ai-section-buttons mb-2">${buttonsHtml}</div>
                <div class="ai-section-panels">${panelsHtml}</div>
            </div>
        `;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text == null ? '' : String(text);
        return div.innerHTML;
    }

    function parseAiSections(raw) {
        const text = (raw || '').replace(/\r\n/g, '\n');
        const known = [
            { key: 'summary', label: '–ö–û–ù–°–ü–ï–ö–¢' },
            { key: 'keywords', label: '–ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê' },
            { key: 'short', label: '–ö–†–ê–¢–ö–û' },
            { key: 'examples', label: '–ü–†–ò–ú–ï–†–´' },
            { key: 'application', label: '–ü–†–ò–ú–ï–ù–ï–ù–ò–ï' },
            { key: 'memory', label: '–ó–ê–ü–û–ú–ù–ò–¢–¨' },
            { key: 'additional', label: '–î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û' },
            { key: 'related', label: '–°–í–Ø–ó–ê–ù–ù–´–ï –¢–ï–ú–´' },
        ];

        const sections = [];

        const topicMatch = text.match(/^\s*(?:[\u{1F300}-\u{1FAFF}]\s*)?–¢–ï–ú–ê\s*:\s*(.+)\s*$/gmiu);
        if (topicMatch && topicMatch.length > 0) {
            const first = topicMatch[0];
            const value = (first.split(':').slice(1).join(':') || '').trim();
            if (value) {
                sections.push({ id: 'topic', title: '–¢–ï–ú–ê', content: value });
            }
        }

        const headerRegex = /^(?:[\u{1F300}-\u{1FAFF}]\s*)?([A-Z–ê-–Ø–Å\s]+)\s*:\s*$/gmu;
        const matches = [];
        let m;
        while ((m = headerRegex.exec(text)) !== null) {
            const rawHeader = (m[1] || '').trim();
            const normalized = rawHeader.replace(/\s+/g, ' ').toUpperCase();
            const found = known.find(k => k.label.toUpperCase() === normalized);
            if (!found) continue;
            matches.push({
                key: found.key,
                label: found.label,
                index: m.index,
                endIndex: headerRegex.lastIndex,
            });
        }

        if (matches.length === 0) return sections;

        for (let i = 0; i < matches.length; i++) {
            const cur = matches[i];
            const next = matches[i + 1];
            const contentStart = cur.endIndex;
            const contentEnd = next ? next.index : text.length;
            const content = text.slice(contentStart, contentEnd).trim();
            if (!content) continue;
            sections.push({
                id: cur.key,
                title: cur.label,
                content,
            });
        }

        const prefer = ['short', 'summary', 'keywords', 'examples', 'application', 'memory', 'additional', 'related', 'topic'];
        sections.sort((a, b) => {
            const ai = prefer.indexOf(a.id);
            const bi = prefer.indexOf(b.id);
            if (ai === -1 && bi === -1) return 0;
            if (ai === -1) return 1;
            if (bi === -1) return -1;
            return ai - bi;
        });

        return sections;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –æ–±—ã—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    function structureResponse(response) {
        if (response.length < 200) {
            return `üìö –ö–û–ù–°–ü–ï–ö–¢:
${response}

ÔøΩ –ö–†–ê–¢–ö–û:
–ö—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–∏ —Ç–µ–º—ã —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≤–∞–∂–Ω–æ—Å—Ç—å.

üí° –ü–†–ò–ú–ï–†–´:
- –ü—Ä–∏–º–µ—Ä 1 –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏
- –ü—Ä–∏–º–µ—Ä 2 –∏–∑ —É—á–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏

üéØ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï:
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: –∏–∑—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
- –ü—Ä–∞–∫—Ç–∏–∫–∞: –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∑–∞–¥–∞—á–∞—Ö

üß† –ó–ê–ü–û–ú–ù–ò–¢–¨:
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.

üìñ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:
- –£–≥–ª—É–±–ª–µ–Ω–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ —Ç–µ–º—ã
- –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

üîó –°–í–Ø–ó–ê–ù–ù–´–ï –¢–ï–ú–´:
- –ü—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ–º—ã
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Ç–µ–º—ã`;
        }
        
        return `üìö –ö–û–ù–°–ü–ï–ö–¢:
${response}

üìù –ö–†–ê–¢–ö–û:
–ö—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–¥–µ–∏ —Ç–µ–º—ã —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≤–∞–∂–Ω–æ—Å—Ç—å.

üí° –ü–†–ò–ú–ï–†–´:
- –ü—Ä–∏–º–µ—Ä 1 –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏
- –ü—Ä–∏–º–µ—Ä 2 –∏–∑ —É—á–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏

üéØ –ü–†–ò–ú–ï–ù–ï–ù–ò–ï:
- –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ: –∏–∑—É—á–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏
- –ü—Ä–∞–∫—Ç–∏–∫–∞: –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∑–∞–¥–∞—á–∞—Ö
–û–±–ª–∞—Å—Ç–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–Ω–∞–Ω–∏–π –≤ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏

üß† –ó–ê–ü–û–ú–ù–ò–¢–¨:
–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –º–Ω–µ–º–æ—Ç–µ—Ö–Ω–∏–∫–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑—É—á–µ–Ω–∏—è

üìñ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û:
–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–≥–æ –∏–∑—É—á–µ–Ω–∏—è –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

üîó –°–í–Ø–ó–ê–ù–ù–´–ï –¢–ï–ú–´:
–°–º–µ–∂–Ω—ã–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—ã –∏ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–º—ã`;
    }

    // –ü—Ä–∏–º–µ—Ä—ã –≤–æ–ø—Ä–æ—Å–æ–≤
    document.querySelectorAll('.example-question').forEach(button => {
        button.addEventListener('click', function() {
            questionInput.value = this.textContent.trim();
            chatForm.dispatchEvent(new Event('submit'));
        });
    });
    
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã"
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('toggle-sections') || e.target.parentElement.classList.contains('toggle-sections')) {
            const button = e.target.classList.contains('toggle-sections') ? e.target : e.target.parentElement;
            const sectionsContent = button.closest('.topic-summary').nextElementSibling;
            const toggleText = button.querySelector('.toggle-text');
            
            if (sectionsContent.style.display === 'none') {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã
                sectionsContent.style.display = 'block';
                toggleText.textContent = 'üìñ –°–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª—ã';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ –µ—Å–ª–∏ –∏—Ö –µ—â–µ –Ω–µ—Ç
                if (!sectionsContent.querySelector('.section-buttons')) {
                    const sectionButtons = `
                        <div class="section-buttons mb-3">
                            <button class="btn btn-sm btn-outline-primary section-btn" data-section="koncept">
                                üìö –ö–æ–Ω—Å–ø–µ–∫—Ç
                            </button>
                            <button class="btn btn-sm btn-outline-success section-btn" data-section="keywords">
                                üîë –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
                            </button>
                            <button class="btn btn-sm btn-outline-info section-btn" data-section="short">
                                üìù –ö—Ä–∞—Ç–∫–æ
                            </button>
                            <button class="btn btn-sm btn-outline-warning section-btn" data-section="examples">
                                üí° –ü—Ä–∏–º–µ—Ä—ã
                            </button>
                            <button class="btn btn-sm btn-outline-secondary section-btn" data-section="application">
                                üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
                            </button>
                            <button class="btn btn-sm btn-outline-dark section-btn" data-section="memory">
                                üß† –ó–∞–ø–æ–º–Ω–∏—Ç—å
                            </button>
                            <button class="btn btn-sm btn-outline-info section-btn" data-section="additional">
                                üìñ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
                            </button>
                            <button class="btn btn-sm btn-outline-primary section-btn" data-section="related">
                                üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã
                            </button>
                        </div>
                    `;
                    sectionsContent.insertAdjacentHTML('afterbegin', sectionButtons);
                }
            } else {
                // –°–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª—ã
                sectionsContent.style.display = 'none';
                toggleText.textContent = 'üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã';
            }
        }
    });
    
    // –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('section-btn')) {
            const section = e.target.dataset.section;
            const contentDiv = e.target.closest('.bg-light').querySelector('.ai-response-content');
            const sections = contentDiv.querySelectorAll('.section-title');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª
            sections.forEach(sectionTitle => {
                if (sectionTitle.dataset.section === section) {
                    const nextElement = sectionTitle.nextElementSibling;
                    let content = '';
                    
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
                    let currentElement = nextElement;
                    while (currentElement && !currentElement.classList.contains('section-title')) {
                        if (currentElement.tagName !== 'DIV' || !currentElement.classList.contains('section-buttons')) {
                            content += currentElement.outerHTML;
                        }
                        currentElement = currentElement.nextElementSibling;
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º
                    showSectionModal(e.target.textContent.trim(), content);
                }
            });
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å —Ä–∞–∑–¥–µ–ª–æ–º
    function showSectionModal(title, content) {
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="ai-response">${content}</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                        <button type="button" class="btn btn-primary copy-section">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        modal.addEventListener('click', function(e) {
            if (e.target === modal || e.target.classList.contains('btn-close') || e.target.classList.contains('btn-secondary')) {
                document.body.removeChild(modal);
            }
        });
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
        modal.querySelector('.copy-section').addEventListener('click', function() {
            const text = modal.querySelector('.ai-response').innerText;
            navigator.clipboard.writeText(text).then(() => {
                this.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => {
                    this.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å';
                }, 2000);
            });
        });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const question = questionInput.value.trim();
        if (!question) return;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        sendText.classList.add('d-none');
        spinner.classList.remove('d-none');
        sendBtn.disabled = true;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userMessage = `
            <div class="mb-3">
                <div class="d-flex justify-content-end mb-2">
                    <div class="bg-primary text-white p-3 rounded-3" style="max-width: 70%;">
                        <strong>–í—ã:</strong><br>
                        ${question}
                        <br>
                        <small>${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</small>
                    </div>
                </div>
            </div>
        `;
        chatHistory.insertAdjacentHTML('beforeend', userMessage);
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–∞–π–º–∞—É—Ç–æ–º
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è OpenAI
        
        fetch('{% url "ai_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `question=${encodeURIComponent(question)}&csrfmiddlewaretoken=${encodeURIComponent(document.querySelector('[name=csrfmiddlewaretoken]').value)}`,
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Received data:", data); // –û—Ç–ª–∞–¥–∫–∞
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç AI
            const formattedResponse = formatAIResponse(data.response);
            
            console.log("Formatted response for display:", formattedResponse); // –û—Ç–ª–∞–¥–∫–∞
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
            const aiMessage = `
                <div class="mb-3">
                    <div class="d-flex justify-content-start mb-2">
                        <div class="bg-light p-3 rounded-3" style="max-width: 80%;">
                            <strong>ü§ñ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç:</strong><br>
                            <div class="ai-response">${formattedResponse}</div>
                            <br>
                            <small class="text-muted">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</small>
                        </div>
                    </div>
                    ${data.cards && data.cards.length > 0 ? `
                        <div class="ms-3 mt-2">
                            <small class="text-muted">
                                <i class="fas fa-book me-1"></i>–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:
                            </small>
                            <div class="mt-1">
                                ${data.cards.map(card => 
                                    `<a href="/knowledge-cards/${card.id}/" class="badge bg-info text-decoration-none me-1">${card.title}</a>`
                                ).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', aiMessage);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            questionInput.value = '';
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error:', error);
            
            let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
            
            if (error.name === 'AbortError') {
                errorMessage = '–ó–∞–ø—Ä–æ—Å –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –≤–æ–ø—Ä–æ—Å.';
            } else if (error.message.includes('402')) {
                errorMessage = 'API —Ç—Ä–µ–±—É–µ—Ç –æ–ø–ª–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å.';
            } else if (error.message.includes('500')) {
                errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
            const errorDiv = `
                <div class="mb-3">
                    <div class="d-flex justify-content-start mb-2">
                        <div class="bg-danger text-white p-3 rounded-3" style="max-width: 70%;">
                            <strong>üö® –û—à–∏–±–∫–∞:</strong><br>
                            ${errorMessage}
                        </div>
                    </div>
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', errorDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        })
        .finally(() => {
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            sendText.classList.remove('d-none');
            spinner.classList.add('d-none');
            sendBtn.disabled = false;
        });
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –æ—Ç–≤–µ—Ç–∞
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.ai-section-btn');
        if (!btn) return;

        const root = btn.closest('.ai-sectioned-response');
        if (!root) return;

        const sectionId = btn.getAttribute('data-section-id');
        root.querySelectorAll('.ai-section-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        root.querySelectorAll('.ai-section-panel').forEach(p => {
            if (p.getAttribute('data-section-id') === sectionId) {
                p.classList.add('active');
            } else {
                p.classList.remove('active');
            }
        });
    });
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ -->
<div class="modal fade" id="sectionModal" tabindex="-1" aria-labelledby="sectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sectionModalLabel">–†–∞–∑–¥–µ–ª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="sectionContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–∞–∑–¥–µ–ª–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Å—é–¥–∞ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('section-btn')) {
        e.preventDefault();
        
        // –ù–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏
        const sectionsContainer = e.target.closest('.sections-content');
        if (!sectionsContainer) return;
        
        // –ü–æ–ª—É—á–∞–µ–º HTML –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤—Å–µ—Ö —Ä–∞–∑–¥–µ–ª–æ–≤
        const sectionsHTML = sectionsContainer.innerHTML;
        
        // –†–∞–∑–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ –∫–Ω–æ–ø–∫–∞–º
        const buttonRegex = /<button[^>]*class="[^"]*section-btn[^"]*"[^>]*>[^<]*<\/button>/g;
        const parts = sectionsHTML.split(buttonRegex);
        
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–∏
        const allButtons = sectionsContainer.querySelectorAll('.section-btn');
        const buttonIndex = Array.from(allButtons).indexOf(e.target);
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–¥–µ–ª–∞
        let sectionContent = '';
        if (buttonIndex < parts.length - 1) {
            sectionContent = parts[buttonIndex + 1] || '';
        }
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –æ—Ç –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
        sectionContent = sectionContent.trim();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modal = new bootstrap.Modal(document.getElementById('sectionModal'));
        const modalTitle = document.getElementById('sectionModalLabel');
        const modalBody = document.getElementById('sectionContent');
        
        modalTitle.textContent = e.target.textContent.trim();
        modalBody.innerHTML = sectionContent;
        
        modal.show();
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã"
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('toggle-sections')) {
        const sectionsContent = e.target.closest('.topic-summary').nextElementSibling;
        const toggleText = e.target.querySelector('.toggle-text');
        
        if (sectionsContent.style.display === 'none') {
            sectionsContent.style.display = 'block';
            toggleText.textContent = 'üìñ –°–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª—ã';
        } else {
            sectionsContent.style.display = 'none';
            toggleText.textContent = 'üìñ –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–¥–µ–ª—ã';
        }
    }
});
</script>

<style>
.ai-response {
    line-height: 1.6;
}

.ai-response strong {
    color: #0066cc;
    font-size: 1.1em;
}

.ai-response .section-title {
    font-weight: bold;
    color: #333;
    margin-top: 15px;
    margin-bottom: 8px;
    padding: 5px 0;
    border-bottom: 2px solid #e9ecef;
}

.ai-response ul {
    margin-left: 20px;
    margin-top: 5px;
}

.ai-response li {
    margin-bottom: 3px;
}

.ai-response .keyword {
    background: #f8f9fa;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9em;
}

.ai-response .example {
    background: #e8f5e8;
    padding: 10px;
    border-radius: 5px;
    margin: 8px 0;
    border-left: 4px solid #28a745;
}

.ai-response .application {
    background: #fff3cd;
    padding: 10px;
    border-radius: 5px;
    margin: 8px 0;
    border-left: 4px solid #ffc107;
}

.section-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.ai-section-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.ai-section-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: transparent;
    color: white;
}

.ai-section-panel {
    display: none;
}

.ai-section-panel.active {
    display: block;
}

.section-btn {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 15px;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1050;
}

.modal-dialog {
    position: relative;
    margin: 50px auto;
    max-width: 800px;
}

.modal-content {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.btn-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
}

.ai-response-content {
    display: none;
}

.ai-response-content.active {
    display: block;
}
</style>
{% endblock %}
