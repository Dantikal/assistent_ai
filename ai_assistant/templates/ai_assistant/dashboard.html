{% extends 'base.html' %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å - StudySense{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ student.user.get_full_name }}!</h1>
        <p class="text-muted">–ì—Ä—É–ø–ø–∞: {{ student.group }}</p>
    </div>
    <div class="col-md-4 text-end">
        {% if student.telegram_chat_id %}
            <span class="badge bg-success">
                <i class="fas fa-telegram me-1"></i>Telegram –ø–æ–¥–∫–ª—é—á–µ–Ω
            </span>
        {% else %}
            <span class="badge bg-warning">
                <i class="fas fa-telegram me-1"></i>Telegram –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
            </span>
        {% endif %}
    </div>
</div>

<div class="row mt-4">
    <!-- –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
                </h5>
            </div>
            <div class="card-body">
                {% if today_schedules %}
                    {% for schedule in today_schedules %}
                        <div class="schedule-card card mb-2 {% if next_class == schedule %}border-primary{% endif %}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="card-title mb-1">{{ schedule.subject.name }}</h6>
                                        <p class="card-text text-muted mb-1">
                                            <i class="fas fa-user-tie me-1"></i>{{ schedule.subject.teacher.get_full_name }}
                                        </p>
                                        <p class="card-text text-muted mb-0">
                                            <i class="fas fa-clock me-1"></i>{{ schedule.start_time }} - {{ schedule.end_time }}
                                            <i class="fas fa-door-open ms-2 me-1"></i>{{ schedule.room }}
                                        </p>
                                    </div>
                                    {% if next_class == schedule %}
                                        <span class="badge bg-primary">–°–ª–µ–¥—É—é—â–∞—è</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">–ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø–∞—Ä –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π—Ç–µ! üòä</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∏–∑—É—á–µ–Ω–∏—è -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑—É—á–µ–Ω–Ω—ã–µ —Ç–µ–º—ã
                </h5>
            </div>
            <div class="card-body">
                {% if recent_progress %}
                    {% for progress in recent_progress %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-1">{{ progress.knowledge_card.title }}</h6>
                                <small class="text-muted">{{ progress.knowledge_card.subject.name }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-{{ progress.mastery_level|yesno:'success,warning,info,primary' }}">
                                    {{ progress.get_mastery_level_display }}
                                </span>
                                <br>
                                <small class="text-muted">{{ progress.access_count }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</small>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">–í—ã –µ—â–µ –Ω–µ –∏–∑—É—á–∞–ª–∏ —Ç–µ–º—ã. –ù–∞—á–Ω–∏—Ç–µ —Å <a href="{% url 'knowledge_cards' %}">–∫–∞—Ä—Ç–æ—á–µ–∫ –∑–Ω–∞–Ω–∏–π</a>!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ó–∞–º–µ—Ç–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ -->
<div class="row mt-4">
    <!-- –ë—ã—Å—Ç—Ä–∞—è –∑–∞–º–µ—Ç–∫–∞ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>–ë—ã—Å—Ç—Ä–∞—è –∑–∞–º–µ—Ç–∫–∞
                </h5>
            </div>
            <div class="card-body">
                <form id="quickNoteForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        {{ quick_note_form.title }}
                    </div>
                    <div class="mb-3">
                        <label for="id_content" class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                        {{ quick_note_form.content }}
                    </div>
                    <div class="mb-3">
                        <label for="id_priority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                        {{ quick_note_form.priority }}
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-2"></i>–°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- –°—Ä–æ—á–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>–°—Ä–æ—á–Ω—ã–µ –∑–∞–¥–∞—á–∏
                </h5>
            </div>
            <div class="card-body">
                {% if urgent_notes %}
                    {% for note in urgent_notes %}
                        <div class="alert alert-danger alert-dismissible fade show mb-2" role="alert" data-note-id="{{ note.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">{{ note.title }}</h6>
                                    <p class="mb-1">{{ note.content|truncatewords:15 }}</p>
                                    <small class="text-muted">{{ note.created_at|date:"H:i" }}</small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success btn-complete-note" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-delete-note" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-check-circle me-2"></i>–°—Ä–æ—á–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-sticky-note me-2"></i>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏
                </h5>
            </div>
            <div class="card-body">
                {% if recent_notes %}
                    {% for note in recent_notes %}
                        <div class="alert {% if note.priority == 'high' %}alert-warning{% elif note.priority == 'medium' %}alert-info{% else %}alert-secondary{% endif %} alert-dismissible fade show mb-2" role="alert" data-note-id="{{ note.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1">
                                        {{ note.title }}
                                        {% if note.is_pinned %}
                                            <i class="fas fa-thumbtack text-primary ms-1"></i>
                                        {% endif %}
                                    </h6>
                                    <p class="mb-1">{{ note.content|truncatewords:15 }}</p>
                                    <small class="text-muted">
                                        {{ note.created_at|date:"H:i" }} 
                                        <span class="badge bg-{{ note.priority|yesno:'danger,warning,info,secondary' }} ms-1">
                                            {{ note.get_priority_display }}
                                        </span>
                                    </small>
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success btn-complete-note" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-delete-note" title="–£–¥–∞–ª–∏—Ç—å">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">
                        <i class="fas fa-info-circle me-2"></i>–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'ai_chat' %}" class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-robot fa-2x mb-2"></i>
                            –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å AI
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'knowledge_cards' %}" class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-book fa-2x mb-2"></i>
                            –ò–∑—É—á–∏—Ç—å —Ç–µ–º—ã
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'schedule' %}" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-calendar fa-2x mb-2"></i>
                            –ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="/admin/" class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center">
                            <i class="fas fa-cog fa-2x mb-2"></i>
                            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –±—ã—Å—Ç—Ä–æ–π –∑–∞–º–µ—Ç–∫–∏
document.getElementById('quickNoteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('{% url "create_quick_note" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            this.reset();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É –≤ DOM
            const newNote = createNoteElement(data);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–º–µ—Ç–æ–∫
            const recentNotesContainer = document.querySelector('.col-md-4:last-child .card-body');
            const emptyMessage = recentNotesContainer.querySelector('.text-muted');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            // –ï—Å–ª–∏ –∑–∞–º–µ—Ç–∫–∞ —Å—Ä–æ—á–Ω–∞—è, –¥–æ–±–∞–≤–ª—è–µ–º –∏ –≤ —Å—Ä–æ—á–Ω—ã–µ
            if (data.priority === 'urgent') {
                const urgentContainer = document.querySelector('.col-md-4:nth-child(2) .card-body');
                const urgentEmpty = urgentContainer.querySelector('.text-muted');
                if (urgentEmpty) {
                    urgentEmpty.remove();
                }
                const urgentNote = createNoteElement(data, true);
                urgentContainer.insertAdjacentHTML('afterbegin', urgentNote);
            } else {
                recentNotesContainer.insertAdjacentHTML('afterbegin', newNote);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification('–ó–∞–º–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        } else {
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'danger');
    });
});

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∑–∞–º–µ—Ç–∫–∏
function createNoteElement(noteData, isUrgent = false) {
    const alertClass = isUrgent ? 'alert-danger' : 
                      (noteData.priority === 'high' ? 'alert-warning' : 
                       noteData.priority === 'medium' ? 'alert-info' : 'alert-secondary');
    
    return `
        <div class="alert ${alertClass} alert-dismissible fade show mb-2" role="alert" data-note-id="${noteData.note_id}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h6 class="alert-heading mb-1">${noteData.title}</h6>
                    <p class="mb-1">${noteData.content}</p>
                    <small class="text-muted">
                        ${noteData.created_at}
                        <span class="badge bg-${noteData.priority === 'urgent' ? 'danger' : noteData.priority === 'high' ? 'warning' : noteData.priority === 'medium' ? 'info' : 'secondary'} ms-1">
                            ${noteData.priority_label}
                        </span>
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-success btn-complete-note" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-delete-note" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–º–µ—Ç–æ–∫
document.addEventListener('click', function(e) {
    // –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º"
    if (e.target.closest('.btn-complete-note')) {
        const noteElement = e.target.closest('[data-note-id]');
        const noteId = noteElement.dataset.noteId;
        
        fetch(`/notes/${noteId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                noteElement.style.opacity = data.is_completed ? '0.5' : '1';
                noteElement.style.textDecoration = data.is_completed ? 'line-through' : 'none';
                showNotification(data.is_completed ? '–ó–∞–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!' : '–ó–∞–º–µ—Ç–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è', 'success');
            }
        });
    }
    
    // –ö–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å"
    if (e.target.closest('.btn-delete-note')) {
        const noteElement = e.target.closest('[data-note-id]');
        const noteId = noteElement.dataset.noteId;
        
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
            fetch(`/notes/${noteId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    noteElement.remove();
                    showNotification('–ó–∞–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞–º–µ—Ç–æ–∫
                    checkEmptyNotes();
                }
            });
        }
    }
});

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—É—Å—Ç—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
function checkEmptyNotes() {
    const recentContainer = document.querySelector('.col-md-4:last-child .card-body');
    const urgentContainer = document.querySelector('.col-md-4:nth-child(2) .card-body');
    
    if (recentContainer && recentContainer.children.length === 0) {
        recentContainer.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-info-circle me-2"></i>–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>';
    }
    
    if (urgentContainer && urgentContainer.children.length === 0) {
        urgentContainer.innerHTML = '<p class="text-muted mb-0"><i class="fas fa-check-circle me-2"></i>–°—Ä–æ—á–Ω—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç!</p>';
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}
